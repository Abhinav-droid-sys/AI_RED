<!-- AUTH-GUARD-TEST -->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RED AI üê¶‚Äçüî•</title>

<meta name="theme-color" content="#0A0A0B" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
/* ===== ORIGINAL STYLES (UNCHANGED) ===== */
:root{
  --red:#FF3B30;
  --red2:#FF6B6B;
  --bg:#060607;
  --glass:rgba(255,255,255,0.06);
  --glass-border:rgba(255,255,255,0.12);
  --muted:#9B9BA6;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:white;
  overflow:auto;
}

/* ================= BACKGROUND ================= */
.bg-wrap{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}

.bg-layer{
  position:absolute;
  inset:-10%;
  background-size:cover;
  background-position:center;
  filter:blur(28px) brightness(0.38) saturate(1.1);
  opacity:0;
  transform:scale(1.04);
  transition:opacity 900ms ease, transform 900ms ease;
}
.bg-layer.visible{
  opacity:1;
  transform:scale(1);
}

.bg-hue{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,59,48,0.12), transparent 45%),
    linear-gradient(180deg, rgba(10,10,11,0.4), rgba(10,10,11,0.85));
  mix-blend-mode:overlay;
}

/* ================= APP ================= */
.app{
  position:relative;
  z-index:2;
  max-width:980px;
  margin:14px auto;
  height:calc(100dvh - 28px);
  display:flex;
  flex-direction:column;
  gap:12px;
  padding:12px;
}

/* ================= HEADER ================= */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-radius:16px;
  background:var(--glass);
  backdrop-filter:blur(18px) saturate(1.2);
  border:1px solid var(--glass-border);
}

.brand{
  font-size:20px;
  font-weight:800;
  background:linear-gradient(135deg,var(--red),var(--red2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.icon-btn{
  background:none;
  border:none;
  color:white;
  font-size:20px;
  cursor:pointer;
  margin-left:14px;
}

/* ================= CHAT BOX ================= */
.chat-box{
  flex:1;
  display:flex;
  flex-direction:column;
  border-radius:18px;
  background:var(--glass);
  backdrop-filter:blur(20px) saturate(1.15);
  border:1px solid var(--glass-border);
  overflow:hidden;
}

.messages{
  flex:1;
  padding:18px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.msg{ display:flex; max-width:85%; }
.msg.user{ align-self:flex-end; }

.bubble{
  padding:12px 16px;
  border-radius:16px;
  line-height:1.45;
  font-size:15px;
}
.bubble.user{
  background:linear-gradient(135deg,var(--red),var(--red2));
  border-bottom-right-radius:6px;
}
.bubble.bot{
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.14);
  border-bottom-left-radius:6px;
}

/* ================= INPUT ================= */
.input-wrap{
  position:sticky;
  bottom:0;
  padding:14px;
  background:rgba(6,6,7,0.45);
  backdrop-filter:blur(18px);
  border-top:1px solid rgba(255,255,255,0.08);
}

.input-row{
  display:flex;
  gap:12px;
  padding:12px;
  border-radius:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid var(--glass-border);
}

textarea{
  flex:1;
  resize:none;
  background:none;
  border:none;
  outline:none;
  color:white;
  font-size:15px;
  max-height:140px;
}

.send{
  width:48px;
  height:48px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,var(--red),var(--red2));
  color:white;
  font-size:18px;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- ===== STEP 1: AUTH GUARD ===== -->
<script>
  const idToken = localStorage.getItem("idToken");
  if (!idToken) {
    window.location.href = "/login";
  }
</script>

<!-- BACKGROUND -->
<div class="bg-wrap">
  <div id="bgA" class="bg-layer"></div>
  <div id="bgB" class="bg-layer"></div>
  <div class="bg-hue"></div>
</div>

<div class="app">

  <div class="header">
    <div class="brand">RED</div>

    <div>
      <!-- EXISTING BUTTON -->
      <button class="icon-btn" onclick="toggleSheet()">
        <i class="fas fa-layer-group"></i>
      </button>

      <!-- ‚úÖ NEW: LOGOUT BUTTON (MINIMAL) -->
      <button class="icon-btn" id="logoutBtn" title="Logout">
        <i class="fas fa-right-from-bracket"></i>
      </button>
    </div>
  </div>

  <div class="chat-box">
    <div class="messages" id="messages">
      <div class="msg">
        <div class="bubble bot">üî• Welcome to RED. Ask me anything.</div>
      </div>
    </div>

    <div class="input-wrap">
      <div class="input-row">
        <textarea id="input" rows="1" placeholder="Ask RED..."></textarea>
        <button class="send" onclick="sendMessage()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

</div>

<!-- ===== FIREBASE LOGOUT (ONLY ADDITION) ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdWXUryACInTpa_BqZ2giTF8UYJFWUz-c",
  authDomain: "red-ai-ab571.firebaseapp.com",
  projectId: "red-ai-ab571",
  appId: "1:789433608850:web:b61b2e86570b093331544b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  localStorage.removeItem("idToken");
  window.location.href = "/login";
};
</script>

<script>
/* ========== BACKGROUND SHUFFLE (UNCHANGED) ========== */
const bgA = document.getElementById("bgA");
const bgB = document.getElementById("bgB");
let activeLayer = "A";

function loremImage(seed){
  const isMobile = window.innerWidth < 600;
  const w = isMobile ? 900 : 1400;
  const h = isMobile ? 600 : 900;
  return `https://picsum.photos/seed/${seed}/${w}/${h}`;
}

function crossfadeBg(){
  const seed = Math.floor(Math.random()*100000);
  const next = activeLayer==="A"?"B":"A";
  const el = next==="A"?bgA:bgB;

  el.classList.remove("visible");
  el.style.backgroundImage = `url("${loremImage(seed)}")`;

  requestAnimationFrame(()=>requestAnimationFrame(()=>el.classList.add("visible")));

  const prev = next==="A"?bgB:bgA;
  prev.classList.remove("visible");
  activeLayer = next;
}

crossfadeBg();
setInterval(crossfadeBg, 20000);

/* ========== CHAT (UNCHANGED) ========== */
const messages = document.getElementById("messages");
const input = document.getElementById("input");

async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;

  addMsg(text,"user");
  input.value="";
  addMsg("...","bot");

  try{
    const token = localStorage.getItem("idToken");

    const r = await fetch("/api/chat",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body:JSON.stringify({
        prompt:text,
        session_id:"glass_mobile",
        is_incognito:false,
        history:[]
      })
    });

    const d = await r.json();
    removeTyping();
    addMsg(d.response || "Error","bot");

  }catch{
    removeTyping();
    addMsg("Network error.","bot");
  }
}

function addMsg(text,role){
  const w=document.createElement("div");
  w.className="msg "+(role==="user"?"user":"");
  const b=document.createElement("div");
  b.className="bubble "+(role==="user"?"user":"bot");
  b.innerText=text;
  w.appendChild(b);
  messages.appendChild(w);
  messages.scrollTop=messages.scrollHeight;
}

function removeTyping(){
  const last=messages.lastChild;
  if(last && last.innerText==="...") last.remove();
}
</script>

</body>
</html>
