<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RED AI üê¶‚Äçüî•</title>

<meta name="theme-color" content="#0A0A0B" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- ===== PRISM ===== -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

<style>
/* ===== ORIGINAL STYLES (UNCHANGED) ===== */
:root{
  --red:#FF3B30;
  --red2:#FF6B6B;
  --bg:#060607;
  --glass:rgba(255,255,255,0.06);
  --glass-border:rgba(255,255,255,0.12);
  --muted:#9B9BA6;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:white;
  overflow:auto;
}

/* ===== BACKGROUND ===== */
.bg-wrap{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}

.bg-layer{
  position:absolute;
  inset:-10%;
  background-size:cover;
  background-position:center;
  filter:blur(28px) brightness(0.38) saturate(1.1);
  opacity:0;
  transform:scale(1.04);
  transition:opacity 900ms ease, transform 900ms ease;
}
.bg-layer.visible{ opacity:1; transform:scale(1); }

.bg-hue{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at 30% 20%, rgba(255,59,48,0.12), transparent 45%),
    linear-gradient(180deg, rgba(10,10,11,0.4), rgba(10,10,11,0.85));
  mix-blend-mode:overlay;
}

/* ===== APP ===== */
.app{
  position:relative;
  z-index:2;
  max-width:980px;
  margin:14px auto;
  height:calc(100dvh - 28px);
  display:flex;
  flex-direction:column;
  gap:12px;
  padding:12px;
}

/* ===== HEADER ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-radius:16px;
  background:var(--glass);
  backdrop-filter:blur(18px) saturate(1.2);
  border:1px solid var(--glass-border);
}

.brand{
  font-size:20px;
  font-weight:800;
  background:linear-gradient(135deg,var(--red),var(--red2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.icon-btn{
  background:none;
  border:none;
  color:white;
  font-size:20px;
  cursor:pointer;
  margin-left:14px;
}

.history-overlay{
  position:fixed;
  inset:0;
  background:rgba(5,5,6,0.62);
  backdrop-filter:blur(2px);
  z-index:40;
  display:none;
}
.history-overlay.open{ display:block; }

.history-panel{
  position:fixed;
  top:0;
  right:-360px;
  width:min(360px,92vw);
  height:100dvh;
  z-index:50;
  background:rgba(10,10,12,0.94);
  border-left:1px solid rgba(255,255,255,0.14);
  backdrop-filter:blur(20px) saturate(1.2);
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  transition:right 220ms ease;
}
.history-panel.open{ right:0; }

.history-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.history-title{
  font-size:16px;
  font-weight:700;
}

.history-actions{
  display:flex;
  gap:8px;
}

.history-btn{
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(255,255,255,0.06);
  color:white;
  border-radius:10px;
  padding:8px 10px;
  font-size:12px;
  cursor:pointer;
}

.history-list{
  margin:0;
  padding:0;
  list-style:none;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.history-item{
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.06);
  border-radius:12px;
  padding:10px;
  cursor:pointer;
}

.history-item.active{
  border-color:rgba(255,107,107,0.75);
  box-shadow:0 0 0 1px rgba(255,107,107,0.25) inset;
}

.history-row{
  display:flex;
  justify-content:space-between;
  gap:8px;
}

.history-item-title{
  font-size:13px;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.history-preview{
  margin-top:6px;
  font-size:12px;
  color:#c7c7d1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.history-time{
  font-size:11px;
  color:#9B9BA6;
}

.history-del{
  background:none;
  border:none;
  color:#ff9a9a;
  cursor:pointer;
  padding:0;
  font-size:13px;
}

.history-empty{
  color:#9B9BA6;
  font-size:13px;
  text-align:center;
  padding:26px 12px;
}

/* ===== CHAT ===== */
.chat-box{
  flex:1;
  display:flex;
  flex-direction:column;
  border-radius:18px;
  background:var(--glass);
  backdrop-filter:blur(20px) saturate(1.15);
  border:1px solid var(--glass-border);
  overflow:hidden;
}

.messages{
  flex:1;
  padding:18px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.msg{ display:flex; max-width:85%; }
.msg.user{ align-self:flex-end; }

.bubble{ 
  padding:12px 16px;
  border-radius:16px;
  line-height:1.45;
  font-size:15px;
}
.bubble.user{
  background:linear-gradient(135deg,var(--red),var(--red2));
  border-bottom-right-radius:6px;
}
.bubble.bot{
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.14);
  border-bottom-left-radius:6px;
}

/* ===== INPUT ===== */
.input-wrap{
  position:sticky;
  bottom:0;
  padding:14px;
  background:rgba(6,6,7,0.45);
  backdrop-filter:blur(18px);
  border-top:1px solid rgba(255,255,255,0.08);
}

.input-row{
  display:flex;
  gap:12px;
  padding:12px;
  border-radius:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid var(--glass-border);
  align-items:center;
}

textarea{
  flex:1;
  resize:none;
  background:none;
  border:none;
  outline:none;
  color:white;
  font-size:15px;
  max-height:140px;
}

.send{
  width:48px;
  height:48px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,var(--red),var(--red2));
  color:white;
  font-size:18px;
  cursor:pointer;
}

/* ===== CODE ===== */
.inline-code{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.16);
  padding:2px 7px;
  border-radius:6px;
  font-size:13px;
}

.code-block{
  margin-top:10px;
  border-radius:14px;
  overflow:hidden;
  background:#0d0f13;
  border:1px solid rgba(255,255,255,0.18);
  box-shadow:0 10px 28px rgba(0,0,0,0.34);
}

.code-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  font-size:12px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  color:#d2d2db;
  border-bottom:1px solid rgba(255,255,255,0.12);
  background:linear-gradient(180deg,#151820,#10131a);
}

.code-lang{
  text-transform:lowercase;
  letter-spacing:0.3px;
}

.copy-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:#ececf4;
  border-radius:8px;
  padding:5px 9px;
  font-size:12px;
  line-height:1;
  cursor:pointer;
}

.copy-btn:hover{
  background:rgba(255,255,255,0.14);
}

.copy-btn:active{
  transform:translateY(1px);
}

.code-block pre{
  margin:0;
  padding:14px 16px 16px;
  overflow:auto;
}

.code-block pre code{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:13px;
}
</style>
</head>

<body>

<!-- ===== BACKGROUND ===== -->
<div class="bg-wrap">
  <div id="bgA" class="bg-layer"></div>
  <div id="bgB" class="bg-layer"></div>
  <div class="bg-hue"></div>
</div>

<div class="app">

<div class="header">
  <div class="brand">RED</div>
  <div>
    <button class="icon-btn" id="historyBtn"><i class="fas fa-layer-group"></i></button>
    <button class="icon-btn" id="logoutBtn"><i class="fas fa-right-from-bracket"></i></button>
  </div>
</div>

<div class="chat-box">
  <div class="messages" id="messages">
    <div class="msg">
      <div class="bubble bot">üî• Welcome to RED. Ask me anything.</div>
    </div>
  </div>

  <div class="input-wrap">
    <div class="input-row">
      <textarea id="input" rows="1" placeholder="Ask RED..."></textarea>
      <button class="send" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

</div>

<div class="history-overlay" id="historyOverlay"></div>
<aside class="history-panel" id="historyPanel">
  <div class="history-head">
    <div class="history-title">Chat History</div>
    <div class="history-actions">
      <button class="history-btn" id="newChatBtn">New</button>
      <button class="history-btn" id="clearChatsBtn">Clear</button>
      <button class="history-btn" id="closeHistoryBtn">Close</button>
    </div>
  </div>
  <ul class="history-list" id="historyList"></ul>
</aside>

<!-- ===== FIREBASE AUTH GUARD (MERGED) ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdWXUryACInTpa_BqZ2giTF8UYJFWUz-c",
  authDomain: "red-ai-ab571.firebaseapp.com",
  projectId: "red-ai-ab571",
  appId: "1:789433608850:web:b61b2e86570b093331544b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* üîê AUTH GUARD */
onAuthStateChanged(auth, async (user) => {
  if (!user || !user.emailVerified) {
    window.location.replace("/login");
    return;
  }
  localStorage.setItem("idToken", await user.getIdToken());
  localStorage.setItem("userId", user.uid);
  localStorage.setItem("userEmail", user.email || "");
});

/* üö™ LOGOUT */
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  localStorage.clear();
  window.location.replace("/login");
};
</script>

<!-- ===== CHAT LOGIC (UNCHANGED) ===== -->
<script>
const messages=document.getElementById("messages");
const input=document.getElementById("input");
const sendBtn=document.getElementById("sendBtn");
const historyBtn=document.getElementById("historyBtn");
const historyOverlay=document.getElementById("historyOverlay");
const historyPanel=document.getElementById("historyPanel");
const historyList=document.getElementById("historyList");
const closeHistoryBtn=document.getElementById("closeHistoryBtn");
const newChatBtn=document.getElementById("newChatBtn");
const clearChatsBtn=document.getElementById("clearChatsBtn");

let activeSessionId=localStorage.getItem("activeSessionId")||"";
let chatCache=[];

function createSessionId(){
  return `chat_${Date.now()}`;
}

function getUserId(){
  return localStorage.getItem("userId") || "anonymous";
}

function authHeaders(){
  return {
    "Content-Type":"application/json",
    "Authorization":`Bearer ${localStorage.getItem("idToken") || ""}`,
    "X-User-Id":getUserId()
  };
}

function setActiveSession(sessionId){
  activeSessionId=sessionId;
  localStorage.setItem("activeSessionId",sessionId);
}

function escapeHtml(t){
  return (t || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function copyCode(btn){
  const c=btn.closest(".code-block").querySelector("code").innerText;
  navigator.clipboard.writeText(c);
  btn.innerHTML='<i class="fas fa-check"></i> Copied';
  setTimeout(()=>btn.innerHTML='<i class="far fa-copy"></i> Copy code',1200);
}

function renderBotMessage(text){
  const source=text || "";
  const codeBlocks=[];
  const withPlaceholders=source.replace(/```([\w#+-]+)?\n([\s\S]*?)```/g,(m,lang,code)=>{
    const blockLang=(lang || "text").toLowerCase();
    const idx=codeBlocks.push(`
      <div class="code-block" data-lang="${blockLang}">
        <div class="code-header">
          <span class="code-lang">${escapeHtml(blockLang)}</span>
          <button class="copy-btn" onclick="copyCode(this)">
            <i class="far fa-copy"></i> Copy code
          </button>
        </div>
        <pre><code class="language-${blockLang}">${escapeHtml(code)}</code></pre>
      </div>
    `)-1;
    return `@@CODE_BLOCK_${idx}@@`;
  });

  let html=escapeHtml(withPlaceholders);
  html=html.replace(/`([^`\n]+)`/g,'<span class="inline-code">$1</span>');
  html=html.replace(/\n/g,"<br>");

  codeBlocks.forEach((block,idx)=>{
    html=html.replace(`@@CODE_BLOCK_${idx}@@`,block);
  });

  return html;
}

function addMsg(text,role){
  const w=document.createElement("div");
  w.className="msg "+(role==="user"?"user":"");
  const b=document.createElement("div");
  b.className="bubble "+(role==="user"?"user":"bot");
  if(role==="bot"){
    b.innerHTML=renderBotMessage(text);
    setTimeout(()=>Prism.highlightAllUnder(b),0);
  }else b.innerText=text;
  w.appendChild(b);
  messages.appendChild(w);
  messages.scrollTop=messages.scrollHeight;
}

function renderWelcome(){
  messages.innerHTML='';
  addMsg("üî• Welcome to RED. Ask me anything.","bot");
}

function formatTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleString([], {month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"});
}

function openHistory(){
  historyOverlay.classList.add("open");
  historyPanel.classList.add("open");
}

function closeHistory(){
  historyOverlay.classList.remove("open");
  historyPanel.classList.remove("open");
}

async function loadHistoryList(){
  try{
    const r=await fetch("/api/chats",{headers:{"X-User-Id":getUserId()}});
    const d=await r.json();
    chatCache=(d.chats || []);
    renderHistoryList(chatCache);
  }catch{
    historyList.innerHTML='<li class="history-empty">Unable to load history.</li>';
  }
}

function renderHistoryList(chats){
  if(!chats.length){
    historyList.innerHTML='<li class="history-empty">No chats yet.</li>';
    return;
  }
  historyList.innerHTML=chats.map(chat=>`
    <li class="history-item ${chat.id===activeSessionId?"active":""}" data-id="${chat.id}">
      <div class="history-row">
        <div class="history-item-title">${escapeHtml(chat.title || "New Chat")}</div>
        <button class="history-del" data-del="${chat.id}" title="Delete chat"><i class="fas fa-trash"></i></button>
      </div>
      <div class="history-preview">${escapeHtml(chat.preview || "No messages yet")}</div>
      <div class="history-time">${escapeHtml(formatTime(chat.updated_at))}</div>
    </li>
  `).join("");
}

async function loadSession(sessionId){
  try{
    const r=await fetch("/api/chat/history",{
      method:"POST",
      headers:authHeaders(),
      body:JSON.stringify({session_id:sessionId})
    });
    const d=await r.json();
    const history=d.history || [];
    messages.innerHTML='';
    if(!history.length){
      renderWelcome();
    }else{
      history.forEach(msg=>addMsg(msg.content,msg.role));
    }
    setActiveSession(sessionId);
    renderHistoryList(chatCache);
    closeHistory();
  }catch{
    addMsg("Failed to load chat history.","bot");
  }
}

async function deleteSession(sessionId){
  await fetch("/api/chat/delete",{
    method:"POST",
    headers:authHeaders(),
    body:JSON.stringify({session_id:sessionId})
  });
  if(activeSessionId===sessionId){
    startNewChat();
  }
  await loadHistoryList();
}

function startNewChat(){
  setActiveSession(createSessionId());
  renderWelcome();
}

async function sendMessage(){
  const text=input.value.trim();
  if(!text) return;
  if(!activeSessionId){
    setActiveSession(createSessionId());
  }
  addMsg(text,"user");
  input.value="";
  addMsg("...","bot");

  try{
    const r=await fetch("/api/chat",{
      method:"POST",
      headers:authHeaders(),
      body:JSON.stringify({prompt:text,history:[],session_id:activeSessionId})
    });
    const d=await r.json();
    messages.lastChild.remove();
    addMsg(d.response||"Error","bot");
    await loadHistoryList();
  }catch{
    messages.lastChild.remove();
    addMsg("Network error.","bot");
  }
}

sendBtn.onclick=sendMessage;
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

historyBtn.onclick=async ()=>{
  openHistory();
  await loadHistoryList();
};
closeHistoryBtn.onclick=closeHistory;
historyOverlay.onclick=closeHistory;
newChatBtn.onclick=()=>{
  startNewChat();
  closeHistory();
};
clearChatsBtn.onclick=async ()=>{
  await fetch("/api/chats/clear",{
    method:"POST",
    headers:authHeaders()
  });
  startNewChat();
  await loadHistoryList();
};

historyList.addEventListener("click",async (e)=>{
  const delBtn=e.target.closest("[data-del]");
  if(delBtn){
    await deleteSession(delBtn.dataset.del);
    return;
  }
  const item=e.target.closest("[data-id]");
  if(item){
    await loadSession(item.dataset.id);
  }
});

(async ()=>{
  if(!activeSessionId){
    startNewChat();
  }else{
    await loadSession(activeSessionId);
  }
  await loadHistoryList();
})();
</script>

</body>
</html>
