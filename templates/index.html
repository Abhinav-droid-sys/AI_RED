<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RED AI üê¶‚Äçüî•</title>

<meta name="theme-color" content="#0A0A0B" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- ===== PRISM ===== -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

<style>
/* ===== ORIGINAL STYLES (UNCHANGED) ===== */
:root{
  --red:#FF3B30;
  --red2:#FF6B6B;
  --bg:#060607;
  --glass:rgba(255,255,255,0.06);
  --glass-border:rgba(255,255,255,0.12);
  --muted:#9B9BA6;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }

body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:#000;
  color:white;
  overflow:auto;
}

/* ===== BACKGROUND ===== */
.bg-wrap{
  position:fixed;
  inset:0;
  z-index:0;
  pointer-events:none;
  overflow:hidden;
}

.bg-layer{
  position:absolute;
  inset:-10%;
  background-size:cover;
  background-position:center;
  filter:blur(28px) brightness(0.38) saturate(1.1);
  opacity:0;
  transform:scale(1.04);
  transition:opacity 900ms ease, transform 900ms ease;
}
.bg-layer.visible{ opacity:1; transform:scale(1); }

.bg-hue{
  position:absolute;
  inset:0;
  background:linear-gradient(180deg, rgba(6,6,7,0.18), rgba(6,6,7,0.66));
}

/* ===== APP ===== */
.app{
  position:relative;
  z-index:2;
  max-width:980px;
  margin:14px auto;
  height:calc(100dvh - 28px);
  display:flex;
  flex-direction:column;
  gap:12px;
  padding:12px;
}

/* ===== HEADER ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 18px;
  border-radius:16px;
  background:var(--glass);
  backdrop-filter:blur(18px) saturate(1.2);
  border:1px solid var(--glass-border);
}

.brand{
  font-size:20px;
  font-weight:800;
  background:linear-gradient(135deg,var(--red),var(--red2));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

.icon-btn{
  background:none;
  border:none;
  color:white;
  font-size:20px;
  cursor:pointer;
  margin-left:14px;
}

.history-overlay{
  position:fixed;
  inset:0;
  background:rgba(6,6,8,0.38);
  backdrop-filter:blur(4px);
  z-index:40;
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition:opacity 220ms ease, visibility 220ms ease;
}
.history-overlay.open{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

.history-panel{
  position:fixed;
  top:12px;
  right:12px;
  width:min(360px,92vw);
  height:calc(100dvh - 24px);
  z-index:50;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.16);
  border-radius:20px;
  box-shadow:0 24px 52px rgba(0,0,0,0.42);
  backdrop-filter:blur(24px) saturate(1.2);
  padding:16px 14px 14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  opacity:0;
  visibility:hidden;
  transform:translateX(108%) scale(0.985);
  pointer-events:none;
  transition:transform 240ms ease, opacity 220ms ease, visibility 220ms ease;
}
.history-panel.open{
  opacity:1;
  visibility:visible;
  transform:translateX(0) scale(1);
  pointer-events:auto;
}

.history-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
}

.history-title{
  font-size:16px;
  font-weight:700;
}

.history-actions{
  display:flex;
  gap:8px;
}

.history-btn{
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.09);
  color:white;
  border-radius:10px;
  padding:8px 10px;
  font-size:12px;
  cursor:pointer;
  transition:background 180ms ease, border-color 180ms ease, transform 120ms ease;
}
.history-btn:hover{
  background:rgba(255,255,255,0.14);
  border-color:rgba(255,255,255,0.24);
}
.history-btn:active{
  transform:translateY(1px);
}

.history-list{
  margin:0;
  padding:0;
  list-style:none;
  overflow:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}

.history-item{
  border:1px solid rgba(255,255,255,0.14);
  background:rgba(255,255,255,0.07);
  border-radius:14px;
  padding:11px;
  cursor:pointer;
  transition:background 190ms ease, border-color 190ms ease, transform 120ms ease, box-shadow 190ms ease;
}
.history-item:hover{
  background:rgba(255,255,255,0.11);
  border-color:rgba(255,255,255,0.2);
  transform:translateY(-1px);
  box-shadow:0 8px 18px rgba(0,0,0,0.18);
}

.history-item.active{
  border-color:rgba(255,107,107,0.75);
  box-shadow:0 0 0 1px rgba(255,107,107,0.25) inset;
}

.history-row{
  display:flex;
  justify-content:space-between;
  gap:8px;
}

.history-item-title{
  font-size:13px;
  font-weight:700;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.history-preview{
  margin-top:6px;
  font-size:12px;
  color:#c7c7d1;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.history-time{
  font-size:11px;
  color:#9B9BA6;
}

.history-del{
  background:none;
  border:none;
  color:#ff9a9a;
  cursor:pointer;
  padding:0;
  font-size:13px;
}

.history-empty{
  color:#9B9BA6;
  font-size:13px;
  text-align:center;
  padding:26px 12px;
}

/* ===== CHAT ===== */
.chat-box{
  flex:1;
  display:flex;
  flex-direction:column;
  border-radius:18px;
  background:var(--glass);
  backdrop-filter:blur(20px) saturate(1.15);
  border:1px solid var(--glass-border);
  overflow:hidden;
}

.messages{
  flex:1;
  padding:18px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:14px;
}

.msg{
  display:flex;
  max-width:85%;
  animation:msgInLeft 300ms cubic-bezier(.2,.85,.25,1);
}
.msg.user{ align-self:flex-end; }
.msg.user{ animation-name:msgInRight; }
.msg.no-anim{ animation:none; }

.bubble{ 
  padding:12px 16px;
  border-radius:16px;
  line-height:1.55;
  font-size:15px;
  box-shadow:0 8px 20px rgba(0,0,0,0.2);
}
.bubble.user{
  background:linear-gradient(135deg,var(--red),var(--red2));
  border-bottom-right-radius:6px;
  border:1px solid rgba(255,255,255,0.22);
  box-shadow:0 10px 24px rgba(255,59,48,0.22), inset 0 1px 0 rgba(255,255,255,0.24);
}
.bubble.bot{
  color:#f2f2f8;
  background:linear-gradient(180deg,rgba(255,255,255,0.11),rgba(255,255,255,0.07));
  border:1px solid rgba(255,255,255,0.16);
  border-bottom-left-radius:6px;
  box-shadow:0 10px 24px rgba(0,0,0,0.26), inset 0 1px 0 rgba(255,255,255,0.08);
}

.bubble.bot h2,
.bubble.bot h3,
.bubble.bot h4{
  margin:14px 0 8px;
  line-height:1.25;
  letter-spacing:-0.02em;
  font-weight:800;
}

.bubble.bot h2{
  font-size:30px;
}

.bubble.bot h3{
  font-size:23px;
}

.bubble.bot h4{
  font-size:18px;
}

.bubble.bot p{
  margin:0 0 12px;
  color:#f0f0f6;
}

.bubble.bot ul,
.bubble.bot ol{
  margin:4px 0 12px 22px;
  padding:0;
}

.bubble.bot li{
  margin:5px 0;
  padding-left:2px;
}

.bubble.bot strong{
  font-weight:800;
}

.bubble.bot .msg-sep{
  border:none;
  border-top:1px solid rgba(255,255,255,0.2);
  margin:14px 0;
}

.bubble.bot blockquote{
  margin:10px 0 14px;
  padding:10px 12px;
  border-left:3px solid rgba(255,107,107,0.75);
  background:rgba(255,255,255,0.06);
  border-radius:10px;
  color:#e6e6f0;
}

.bubble.bot .table-wrap{
  margin:10px 0 14px;
  overflow:auto;
  border:1px solid rgba(255,255,255,0.16);
  border-radius:12px;
  background:rgba(11,13,18,0.72);
}

.bubble.bot table{
  width:100%;
  border-collapse:collapse;
  min-width:420px;
}

.bubble.bot th,
.bubble.bot td{
  text-align:left;
  padding:10px 12px;
  border-bottom:1px solid rgba(255,255,255,0.1);
  font-size:14px;
}

.bubble.bot th{
  font-weight:700;
  background:rgba(255,255,255,0.06);
}

.bubble.bot tr:last-child td{
  border-bottom:none;
}

.typing{
  display:inline-flex;
  gap:6px;
  align-items:center;
  min-height:18px;
}

.typing span{
  width:7px;
  height:7px;
  border-radius:50%;
  background:rgba(255,255,255,0.9);
  opacity:0.3;
  animation:typingPulse 1s infinite ease-in-out;
}

.typing span:nth-child(2){ animation-delay:120ms; }
.typing span:nth-child(3){ animation-delay:240ms; }

.msg-footer{
  margin-top:10px;
  padding-top:2px;
  display:flex;
  gap:6px;
  justify-content:flex-end;
  opacity:0;
  transform:translateY(4px);
  pointer-events:none;
  transition:opacity 160ms ease, transform 160ms ease;
}

.msg:hover .msg-footer{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
}

.msg:focus-within .msg-footer{
  opacity:1;
  transform:translateY(0);
  pointer-events:auto;
}

.msg-footer .action-btn{
  border:1px solid rgba(255,255,255,0.18);
  background:rgba(255,255,255,0.06);
  color:#ebebf4;
  border-radius:999px;
  width:28px;
  height:28px;
  padding:0;
  display:inline-grid;
  place-items:center;
  font-size:11px;
  line-height:1;
  cursor:pointer;
  transition:background 160ms ease, transform 120ms ease, border-color 160ms ease;
  opacity:0.9;
}

.msg-footer .action-btn:hover{
  background:rgba(255,255,255,0.11);
  border-color:rgba(255,255,255,0.22);
  opacity:1;
}

.msg-footer .action-btn:active{
  transform:translateY(1px);
}

/* ===== INPUT ===== */
.input-wrap{
  position:sticky;
  bottom:0;
  padding:14px;
  background:rgba(6,6,7,0.45);
  backdrop-filter:blur(18px);
  border-top:1px solid rgba(255,255,255,0.08);
}

.input-row{
  display:flex;
  gap:12px;
  padding:12px;
  border-radius:14px;
  background:rgba(255,255,255,0.08);
  border:1px solid var(--glass-border);
  align-items:center;
}

textarea{
  flex:1;
  resize:none;
  background:none;
  border:none;
  outline:none;
  color:white;
  font-size:15px;
  max-height:140px;
}

.send{
  width:48px;
  height:48px;
  border:none;
  border-radius:12px;
  background:linear-gradient(135deg,var(--red),var(--red2));
  color:white;
  font-size:18px;
  cursor:pointer;
}

.mic-btn{
  min-width:88px;
  height:48px;
  border:1px solid rgba(255,255,255,0.2);
  border-radius:12px;
  background:rgba(255,255,255,0.08);
  color:#f0f0f6;
  font-size:13px;
  font-weight:600;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  cursor:pointer;
  transition:background 160ms ease, border-color 160ms ease, transform 120ms ease;
}

.mic-btn:hover{
  background:rgba(255,255,255,0.13);
  border-color:rgba(255,255,255,0.28);
}

.mic-btn:active{
  transform:translateY(1px);
}

.mic-btn.listening{
  background:rgba(255,59,48,0.18);
  border-color:rgba(255,107,107,0.45);
  color:#ffd4d4;
}

/* ===== CODE ===== */
.inline-code{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.16);
  padding:2px 7px;
  border-radius:6px;
  font-size:13px;
}

.code-block{
  margin-top:10px;
  border-radius:14px;
  overflow:hidden;
  background:#0d0f13;
  border:1px solid rgba(255,255,255,0.18);
  box-shadow:0 10px 28px rgba(0,0,0,0.34);
}

.code-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 12px;
  font-size:12px;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  color:#d2d2db;
  border-bottom:1px solid rgba(255,255,255,0.12);
  background:linear-gradient(180deg,#151820,#10131a);
}

.code-meta{
  display:flex;
  align-items:center;
  gap:8px;
  min-width:0;
}

.code-icon{
  width:18px;
  text-align:center;
  opacity:0.9;
}

.code-lang{
  text-transform:lowercase;
  letter-spacing:0.3px;
}

.code-file{
  color:#a9afbd;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:130px;
}

.code-actions{
  display:flex;
  align-items:center;
  gap:6px;
}

.copy-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:#ececf4;
  border-radius:8px;
  padding:5px 9px;
  font-size:12px;
  line-height:1;
  cursor:pointer;
}

.copy-btn:hover{
  background:rgba(255,255,255,0.14);
}

.copy-btn:active{
  transform:translateY(1px);
}

.expand-btn{
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:rgba(255,255,255,0.08);
  border:1px solid rgba(255,255,255,0.2);
  color:#ececf4;
  border-radius:8px;
  padding:5px 9px;
  font-size:12px;
  line-height:1;
  cursor:pointer;
}

.expand-btn:hover{
  background:rgba(255,255,255,0.14);
}

.code-block pre{
  margin:0;
  padding:14px 16px 16px;
  overflow:auto;
}

.code-block pre code{
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:13px;
}

.code-modal{
  position:fixed;
  inset:0;
  z-index:80;
  background:rgba(0,0,0,0.58);
  backdrop-filter:blur(5px);
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition:opacity 220ms ease, visibility 220ms ease;
  display:grid;
  place-items:center;
  padding:18px;
}

.code-modal.open{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}

.code-modal-card{
  width:min(980px,96vw);
  height:min(82dvh,760px);
  border-radius:18px;
  overflow:hidden;
  background:#10131a;
  border:1px solid rgba(255,255,255,0.18);
  box-shadow:0 24px 60px rgba(0,0,0,0.5);
  display:flex;
  flex-direction:column;
}

.code-modal-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 14px;
  border-bottom:1px solid rgba(255,255,255,0.12);
  background:linear-gradient(180deg,#171b25,#121621);
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:12px;
}

.code-modal-actions{
  display:flex;
  gap:8px;
}

.code-modal-btn{
  border:1px solid rgba(255,255,255,0.2);
  background:rgba(255,255,255,0.08);
  color:#ececf4;
  border-radius:8px;
  padding:6px 10px;
  font-size:12px;
  cursor:pointer;
}

.code-modal-body{
  flex:1;
  overflow:auto;
}

.line-grid{
  margin:0;
  font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  font-size:13px;
  line-height:1.55;
}

.line-row{
  display:grid;
  grid-template-columns:54px 1fr;
  padding:0 12px 0 0;
}

.line-no{
  color:#6f7686;
  text-align:right;
  padding:0 10px 0 0;
  user-select:none;
  border-right:1px solid rgba(255,255,255,0.08);
  margin-right:12px;
}

.line-code{
  color:#e8eaf0;
  white-space:pre;
}

.toast{
  position:fixed;
  left:50%;
  bottom:26px;
  transform:translateX(-50%) translateY(16px);
  background:rgba(16,18,23,0.9);
  border:1px solid rgba(255,255,255,0.2);
  color:#f1f2f8;
  border-radius:12px;
  padding:8px 12px;
  font-size:12px;
  opacity:0;
  visibility:hidden;
  z-index:90;
  transition:opacity 180ms ease, transform 180ms ease, visibility 180ms ease;
}

.toast.show{
  opacity:1;
  visibility:visible;
  transform:translateX(-50%) translateY(0);
}

@media (max-width:760px){
  .app{
    margin:8px auto;
    height:calc(100dvh - 16px);
    padding:8px;
  }

  .msg{
    max-width:96%;
  }

  .messages{
    padding:14px;
    gap:12px;
  }

  .bubble{
    font-size:14px;
    padding:10px 13px;
  }

  .input-wrap{
    padding:10px;
    backdrop-filter:blur(12px);
  }

  .input-row{
    gap:10px;
    padding:10px;
  }

  .send{
    width:44px;
    height:44px;
    border-radius:10px;
  }

  .mic-btn{
    min-width:76px;
    height:44px;
    border-radius:10px;
    font-size:12px;
  }

  .msg-footer .action-btn{
    width:30px;
    height:30px;
  }

  .msg-footer{
    opacity:1;
    transform:none;
    pointer-events:auto;
  }

  .code-modal{
    padding:8px;
  }

  .code-modal-card{
    width:100%;
    height:90dvh;
    border-radius:14px;
  }
}

@keyframes msgInLeft{
  from{ opacity:0; transform:translateX(-18px) translateY(4px) scale(0.985); filter:blur(3px); }
  to{ opacity:1; transform:translateX(0) translateY(0) scale(1); filter:blur(0); }
}

@keyframes msgInRight{
  from{ opacity:0; transform:translateX(18px) translateY(4px) scale(0.985); filter:blur(3px); }
  to{ opacity:1; transform:translateX(0) translateY(0) scale(1); filter:blur(0); }
}

@keyframes typingPulse{
  0%,80%,100%{ transform:translateY(0); opacity:0.35; }
  40%{ transform:translateY(-3px); opacity:1; }
}
</style>
</head>

<body>

<!-- ===== BACKGROUND ===== -->
<div class="bg-wrap">
  <div id="bgA" class="bg-layer"></div>
  <div id="bgB" class="bg-layer"></div>
  <div class="bg-hue"></div>
</div>

<div class="app">

<div class="header">
  <div class="brand">RED</div>
  <div>
    <button class="icon-btn" id="historyBtn"><i class="fas fa-layer-group"></i></button>
    <button class="icon-btn" id="logoutBtn"><i class="fas fa-right-from-bracket"></i></button>
  </div>
</div>

<div class="chat-box">
  <div class="messages" id="messages">
    <div class="msg">
      <div class="bubble bot">üî• Welcome to RED. Ask me anything.</div>
    </div>
  </div>

  <div class="input-wrap">
    <div class="input-row">
      <textarea id="input" rows="1" placeholder="Ask RED..."></textarea>
      <button class="mic-btn" id="micBtn" type="button"><i class="fas fa-microphone"></i> Voice</button>
      <button class="send" id="sendBtn">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

</div>

<div class="history-overlay" id="historyOverlay"></div>
<aside class="history-panel" id="historyPanel">
  <div class="history-head">
    <div class="history-title">Chat History</div>
    <div class="history-actions">
      <button class="history-btn" id="newChatBtn">New</button>
      <button class="history-btn" id="clearChatsBtn">Clear</button>
      <button class="history-btn" id="closeHistoryBtn">Close</button>
    </div>
  </div>
  <ul class="history-list" id="historyList"></ul>
</aside>

<div class="code-modal" id="codeModal">
  <div class="code-modal-card">
    <div class="code-modal-head">
      <div id="codeModalTitle">code</div>
      <div class="code-modal-actions">
        <button class="code-modal-btn" id="codeModalCopyBtn"><i class="far fa-copy"></i> Copy</button>
        <button class="code-modal-btn" id="codeModalCloseBtn"><i class="fas fa-xmark"></i> Close</button>
      </div>
    </div>
    <div class="code-modal-body">
      <div id="codeModalBody"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ===== FIREBASE AUTH GUARD (MERGED) ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDdWXUryACInTpa_BqZ2giTF8UYJFWUz-c",
  authDomain: "red-ai-ab571.firebaseapp.com",
  projectId: "red-ai-ab571",
  appId: "1:789433608850:web:b61b2e86570b093331544b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

/* üîê AUTH GUARD */
onAuthStateChanged(auth, async (user) => {
  if (!user || !user.emailVerified) {
    window.location.replace("/login");
    return;
  }
  localStorage.setItem("idToken", await user.getIdToken());
  localStorage.setItem("userId", user.uid);
  localStorage.setItem("userEmail", user.email || "");
});

/* üö™ LOGOUT */
document.getElementById("logoutBtn").onclick = async () => {
  await signOut(auth);
  localStorage.clear();
  window.location.replace("/login");
};
</script>

<!-- ===== CHAT LOGIC (UNCHANGED) ===== -->
<script>
const messages=document.getElementById("messages");
const bgA=document.getElementById("bgA");
const bgB=document.getElementById("bgB");
const input=document.getElementById("input");
const micBtn=document.getElementById("micBtn");
const sendBtn=document.getElementById("sendBtn");
const historyBtn=document.getElementById("historyBtn");
const historyOverlay=document.getElementById("historyOverlay");
const historyPanel=document.getElementById("historyPanel");
const historyList=document.getElementById("historyList");
const closeHistoryBtn=document.getElementById("closeHistoryBtn");
const newChatBtn=document.getElementById("newChatBtn");
const clearChatsBtn=document.getElementById("clearChatsBtn");
const codeModal=document.getElementById("codeModal");
const codeModalTitle=document.getElementById("codeModalTitle");
const codeModalBody=document.getElementById("codeModalBody");
const codeModalCopyBtn=document.getElementById("codeModalCopyBtn");
const codeModalCloseBtn=document.getElementById("codeModalCloseBtn");
const toast=document.getElementById("toast");

let activeSessionId=localStorage.getItem("activeSessionId")||"";
let chatCache=[];
let activeBgLayer="A";
let sessionBackgroundMap=JSON.parse(localStorage.getItem("sessionBackgroundMap") || "{}");
let lastBgIndex=Number(localStorage.getItem("lastBgIndex") || "-1");
let lastUserPrompt="";
let codeModalCurrentCode="";
let codeModalCurrentLang="text";
let voiceRecognizer=null;
let isVoiceListening=false;
let voiceShouldSubmit=false;
let finalVoiceText="";

const STOCK_BACKGROUNDS=[
  "https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1920&q=80",
  "https://images.unsplash.com/photo-1447752875215-b2761acb3c5d?auto=format&fit=crop&w=1920&q=80",
  "https://images.unsplash.com/photo-1470770841072-f978cf4d019e?auto=format&fit=crop&w=1920&q=80",
  "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1920&q=80",
  "https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1920&q=80",
  "https://images.unsplash.com/photo-1472214103451-9374bd1c798e?auto=format&fit=crop&w=1920&q=80"
];

function chooseNextBackgroundIndex(){
  if(STOCK_BACKGROUNDS.length<=1) return 0;
  let next=Math.floor(Math.random()*STOCK_BACKGROUNDS.length);
  while(next===lastBgIndex){
    next=Math.floor(Math.random()*STOCK_BACKGROUNDS.length);
  }
  lastBgIndex=next;
  localStorage.setItem("lastBgIndex",String(next));
  return next;
}

function getSessionBackground(sessionId){
  if(!sessionId) return STOCK_BACKGROUNDS[0];
  if(!sessionBackgroundMap[sessionId]){
    const idx=chooseNextBackgroundIndex();
    sessionBackgroundMap[sessionId]=STOCK_BACKGROUNDS[idx];
    localStorage.setItem("sessionBackgroundMap",JSON.stringify(sessionBackgroundMap));
  }
  return sessionBackgroundMap[sessionId];
}

function applySessionBackground(sessionId){
  const nextUrl=getSessionBackground(sessionId);
  const incoming=activeBgLayer==="A" ? bgB : bgA;
  const outgoing=activeBgLayer==="A" ? bgA : bgB;
  incoming.style.backgroundImage=`url("${nextUrl}")`;
  incoming.classList.add("visible");
  outgoing.classList.remove("visible");
  activeBgLayer=activeBgLayer==="A" ? "B" : "A";
}

function createSessionId(){
  return `chat_${Date.now()}`;
}

function getUserId(){
  return localStorage.getItem("userId") || "anonymous";
}

function authHeaders(){
  return {
    "Content-Type":"application/json",
    "Authorization":`Bearer ${localStorage.getItem("idToken") || ""}`,
    "X-User-Id":getUserId()
  };
}

function setActiveSession(sessionId){
  const isChanged=activeSessionId!==sessionId;
  activeSessionId=sessionId;
  localStorage.setItem("activeSessionId",sessionId);
  const hasVisibleBg=bgA.classList.contains("visible") || bgB.classList.contains("visible");
  if(isChanged || !hasVisibleBg){
    applySessionBackground(sessionId);
  }
}

function escapeHtml(t){
  return (t || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function setMicState(listening){
  isVoiceListening=listening;
  micBtn.classList.toggle("listening",listening);
  micBtn.innerHTML=listening
    ? '<i class="fas fa-stop"></i> End'
    : '<i class="fas fa-microphone"></i> Voice';
}

function getSpeechRecognition(){
  return window.SpeechRecognition || window.webkitSpeechRecognition || null;
}

function initVoiceRecognizer(){
  const SpeechRecognition=getSpeechRecognition();
  if(!SpeechRecognition) return null;
  const recognizer=new SpeechRecognition();
  recognizer.lang=navigator.language || "en-US";
  recognizer.continuous=true;
  recognizer.interimResults=true;

  recognizer.onresult=(event)=>{
    let interim="";
    for(let i=event.resultIndex; i<event.results.length; i++){
      const chunk=event.results[i][0]?.transcript || "";
      if(event.results[i].isFinal){
        finalVoiceText+=(chunk + " ");
      }else{
        interim+=chunk;
      }
    }
    const composed=(finalVoiceText + interim).trim();
    if(composed){
      input.value=composed;
      autoResizeInput();
    }
  };

  recognizer.onerror=(event)=>{
    showToast(`Voice error: ${event.error || "unknown"}`);
    setMicState(false);
  };

  recognizer.onend=async ()=>{
    const shouldSubmit=voiceShouldSubmit;
    voiceShouldSubmit=false;
    setMicState(false);
    const rawText=(finalVoiceText || input.value || "").trim();
    finalVoiceText="";
    if(!shouldSubmit || !rawText) return;

    try{
      const r=await fetch("/api/voice/process",{
        method:"POST",
        headers:authHeaders(),
        body:JSON.stringify({text:rawText,target_lang:"en"})
      });
      const d=await r.json();
      const processed=(d.processed_text || rawText).trim();
      input.value=processed;
      autoResizeInput();
      await sendMessage(processed);
    }catch{
      input.value=rawText;
      autoResizeInput();
      await sendMessage(rawText);
    }
  };
  return recognizer;
}

function toggleVoiceInput(){
  if(isVoiceListening){
    voiceShouldSubmit=true;
    voiceRecognizer?.stop();
    return;
  }
  if(!voiceRecognizer){
    voiceRecognizer=initVoiceRecognizer();
  }
  if(!voiceRecognizer){
    showToast("Voice input is not supported in this browser.");
    return;
  }
  finalVoiceText="";
  voiceShouldSubmit=false;
  setMicState(true);
  try{
    voiceRecognizer.start();
  }catch{
    setMicState(false);
    showToast("Unable to start voice recognition.");
  }
}

function showToast(message){
  toast.textContent=message;
  toast.classList.add("show");
  clearTimeout(showToast._timer);
  showToast._timer=setTimeout(()=>toast.classList.remove("show"),1700);
}

function languageMeta(lang){
  const normalized=(lang || "text").toLowerCase();
  const map={
    js:{label:"javascript", icon:"<i class='fab fa-js'></i>", ext:"js"},
    javascript:{label:"javascript", icon:"<i class='fab fa-js'></i>", ext:"js"},
    ts:{label:"typescript", icon:"<i class='fas fa-code'></i>", ext:"ts"},
    typescript:{label:"typescript", icon:"<i class='fas fa-code'></i>", ext:"ts"},
    py:{label:"python", icon:"<i class='fab fa-python'></i>", ext:"py"},
    python:{label:"python", icon:"<i class='fab fa-python'></i>", ext:"py"},
    bash:{label:"bash", icon:"<i class='fas fa-terminal'></i>", ext:"sh"},
    sh:{label:"bash", icon:"<i class='fas fa-terminal'></i>", ext:"sh"},
    html:{label:"html", icon:"<i class='fab fa-html5'></i>", ext:"html"},
    css:{label:"css", icon:"<i class='fab fa-css3-alt'></i>", ext:"css"},
    json:{label:"json", icon:"<i class='fas fa-brackets-curly'></i>", ext:"json"},
    sql:{label:"sql", icon:"<i class='fas fa-database'></i>", ext:"sql"}
  };
  return map[normalized] || {label:normalized || "text", icon:"<i class='fas fa-file-code'></i>", ext:normalized || "txt"};
}

function renderTypingIndicator(){
  return '<div class="typing" aria-label="RED is typing"><span></span><span></span><span></span></div>';
}

function applyInlineFormatting(text){
  return text
    .replace(/`([^`\n]+)`/g,'<span class="inline-code">$1</span>')
    .replace(/\*\*([^*\n]+)\*\*/g,"<strong>$1</strong>")
    .replace(/\*([^*\n]+)\*/g,"<em>$1</em>");
}

function formatStructuredText(escapedText){
  const lines=(escapedText || "").replace(/\r\n/g,"\n").split("\n");
  const out=[];
  let paragraph=[];
  let inUl=false;
  let inOl=false;

  const flushParagraph=()=>{
    if(!paragraph.length) return;
    out.push(`<p>${paragraph.join("<br>")}</p>`);
    paragraph=[];
  };

  const closeLists=()=>{
    if(inUl){ out.push("</ul>"); inUl=false; }
    if(inOl){ out.push("</ol>"); inOl=false; }
  };
  const parseTableRow=(line)=>line.replace(/^\||\|$/g,"").split("|").map(c=>applyInlineFormatting(c.trim()));
  const isTableSeparator=(line)=>/^\s*\|?\s*:?-{3,}:?\s*(\|\s*:?-{3,}:?\s*)+\|?\s*$/.test(line);
  const isPossibleTableRow=(line)=>(line.includes("|") && !/^@@CODE_BLOCK_\d+@@$/.test(line.trim()));

  let i=0;
  while(i<lines.length){
    const line=(lines[i] || "").trim();

    if(/^@@CODE_BLOCK_\d+@@$/.test(line)){
      flushParagraph();
      closeLists();
      out.push(line);
      i++;
      continue;
    }

    if(!line){
      flushParagraph();
      closeLists();
      i++;
      continue;
    }

    if(isPossibleTableRow(line) && i+1<lines.length && isTableSeparator(lines[i+1] || "")){
      flushParagraph();
      closeLists();
      const headers=parseTableRow(line);
      const rows=[];
      i+=2;
      while(i<lines.length){
        const rowLine=(lines[i] || "").trim();
        if(!rowLine || !isPossibleTableRow(rowLine) || /^@@CODE_BLOCK_\d+@@$/.test(rowLine)) break;
        rows.push(parseTableRow(rowLine));
        i++;
      }
      out.push(`<div class="table-wrap"><table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead><tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("")}</tbody></table></div>`);
      continue;
    }

    if(/^>\s?/.test(line)){
      flushParagraph();
      closeLists();
      const quoteLines=[];
      while(i<lines.length){
        const q=(lines[i] || "").trim();
        if(!/^>\s?/.test(q)) break;
        quoteLines.push(applyInlineFormatting(q.replace(/^>\s?/,"")));
        i++;
      }
      out.push(`<blockquote>${quoteLines.join("<br>")}</blockquote>`);
      continue;
    }

    if(/^---+$/.test(line)){
      flushParagraph();
      closeLists();
      out.push('<hr class="msg-sep">');
      i++;
      continue;
    }

    const heading=line.match(/^(#{1,3})\s+(.+)$/);
    if(heading){
      flushParagraph();
      closeLists();
      const level=heading[1].length===1 ? "h2" : heading[1].length===2 ? "h3" : "h4";
      out.push(`<${level}>${applyInlineFormatting(heading[2])}</${level}>`);
      i++;
      continue;
    }

    const ordered=line.match(/^\d+\.\s+(.+)$/);
    if(ordered){
      flushParagraph();
      if(inUl){ out.push("</ul>"); inUl=false; }
      if(!inOl){ out.push("<ol>"); inOl=true; }
      out.push(`<li>${applyInlineFormatting(ordered[1])}</li>`);
      i++;
      continue;
    }

    const unordered=line.match(/^[-*]\s+(.+)$/);
    if(unordered){
      flushParagraph();
      if(inOl){ out.push("</ol>"); inOl=false; }
      if(!inUl){ out.push("<ul>"); inUl=true; }
      out.push(`<li>${applyInlineFormatting(unordered[1])}</li>`);
      i++;
      continue;
    }

    closeLists();
    paragraph.push(applyInlineFormatting(line));
    i++;
  }

  flushParagraph();
  closeLists();
  return out.join("");
}

function copyCode(btn){
  const c=btn.closest(".code-block").querySelector("code").innerText;
  navigator.clipboard.writeText(c);
  btn.innerHTML='<i class="fas fa-check"></i> Copied';
  setTimeout(()=>btn.innerHTML='<i class="far fa-copy"></i> Copy code',1200);
}

function openCodeModal(btn){
  const block=btn.closest(".code-block");
  const codeEl=block?.querySelector("code");
  if(!codeEl) return;
  const lang=(block.dataset.lang || "text").toLowerCase();
  const meta=languageMeta(lang);
  const code=codeEl.innerText || "";

  codeModalCurrentCode=code;
  codeModalCurrentLang=lang;
  codeModalTitle.innerHTML=`${meta.icon} ${escapeHtml(meta.label)} <span style="color:#9ea4b4;">snippet.${escapeHtml(meta.ext)}</span>`;
  const lines=(code.replace(/\r\n/g,"\n")).split("\n");
  codeModalBody.innerHTML=`<div class="line-grid">${lines.map((line,idx)=>`<div class="line-row"><span class="line-no">${idx+1}</span><span class="line-code">${escapeHtml(line)}</span></div>`).join("")}</div>`;
  codeModal.classList.add("open");
}

function closeCodeModal(){
  codeModal.classList.remove("open");
}

function copyBotMessage(btn){
  const wrapper=btn.closest(".msg");
  const raw=wrapper?.__rawText || "";
  if(!raw) return;
  navigator.clipboard.writeText(raw);
  showToast("Response copied.");
}

function explainBotMessage(btn){
  const wrapper=btn.closest(".msg");
  const raw=(wrapper?.__rawText || "").trim();
  if(!raw){
    showToast("Nothing to explain.");
    return;
  }
  input.value=`Explain this answer in simple steps:\n\n${raw.slice(0,2200)}`;
  input.focus();
  input.dispatchEvent(new Event("input"));
}

function getLatestUserPrompt(){
  if(lastUserPrompt) return lastUserPrompt;
  const lastUserBubble=[...messages.querySelectorAll(".msg.user .bubble.user")].at(-1);
  return (lastUserBubble?.innerText || "").trim();
}

async function regenerateFromBot(btn){
  const prompt=getLatestUserPrompt();
  if(!prompt){
    showToast("No previous user prompt found.");
    return;
  }
  await sendMessage(prompt,{asRegenerate:true});
}

function renderBotMessage(text){
  const source=text || "";
  const codeBlocks=[];
  const withPlaceholders=source.replace(/```([\w#+-]+)?\n([\s\S]*?)```/g,(m,lang,code)=>{
    const meta=languageMeta(lang);
    const blockLang=meta.label;
    const idx=codeBlocks.push(`
      <div class="code-block" data-lang="${blockLang}">
        <div class="code-header">
          <div class="code-meta">
            <span class="code-icon">${meta.icon}</span>
            <span class="code-lang">${escapeHtml(meta.label)}</span>
            <span class="code-file">snippet.${escapeHtml(meta.ext)}</span>
          </div>
          <div class="code-actions">
            <button class="copy-btn" onclick="copyCode(this)"><i class="far fa-copy"></i> Copy code</button>
            <button class="expand-btn" onclick="openCodeModal(this)"><i class="fas fa-up-right-and-down-left-from-center"></i> Expand</button>
          </div>
        </div>
        <pre><code class="language-${blockLang}">${escapeHtml(code)}</code></pre>
      </div>
    `)-1;
    return `@@CODE_BLOCK_${idx}@@`;
  });

  let html=escapeHtml(withPlaceholders);
  html=formatStructuredText(html);

  codeBlocks.forEach((block,idx)=>{
    html=html.replace(`@@CODE_BLOCK_${idx}@@`,block);
  });

  return html;
}

function createBotActions(){
  const footer=document.createElement("div");
  footer.className="msg-footer";
  footer.innerHTML=`
    <button class="action-btn" onclick="copyBotMessage(this)" title="Copy" aria-label="Copy"><i class="far fa-copy"></i></button>
    <button class="action-btn" onclick="regenerateFromBot(this)" title="Regenerate" aria-label="Regenerate"><i class="fas fa-rotate-right"></i></button>
    <button class="action-btn" onclick="explainBotMessage(this)" title="Explain" aria-label="Explain"><i class="fas fa-circle-info"></i></button>
  `;
  return footer;
}

function addMsg(text,role,options={}){
  const {animate=true}=options;
  const w=document.createElement("div");
  w.className="msg "+(role==="user"?"user":"");
  if(!animate) w.classList.add("no-anim");
  const b=document.createElement("div");
  b.className="bubble "+(role==="user"?"user":"bot");
  let footer=null;
  if(role==="bot"){
    const isTyping=text==="...";
    if(isTyping){
      b.innerHTML=renderTypingIndicator();
    }else{
      b.innerHTML=renderBotMessage(text);
      setTimeout(()=>Prism.highlightAllUnder(b),0);
      footer=createBotActions();
      w.__rawText=text;
    }
  }else{
    b.innerText=text;
    lastUserPrompt=text;
  }
  w.appendChild(b);
  if(footer) w.appendChild(footer);
  messages.appendChild(w);
  messages.scrollTop=messages.scrollHeight;
  return w;
}

function renderWelcome(){
  messages.innerHTML='';
  addMsg("üî• Welcome to RED. Ask me anything.","bot");
}

function formatTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  return d.toLocaleString([], {month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"});
}

function openHistory(){
  historyOverlay.classList.add("open");
  historyPanel.classList.add("open");
}

function closeHistory(){
  historyOverlay.classList.remove("open");
  historyPanel.classList.remove("open");
}

async function loadHistoryList(){
  try{
    const r=await fetch("/api/chats",{headers:{"X-User-Id":getUserId()}});
    const d=await r.json();
    chatCache=(d.chats || []);
    renderHistoryList(chatCache);
  }catch{
    historyList.innerHTML='<li class="history-empty">Unable to load history.</li>';
  }
}

function renderHistoryList(chats){
  if(!chats.length){
    historyList.innerHTML='<li class="history-empty">No chats yet.</li>';
    return;
  }
  historyList.innerHTML=chats.map(chat=>`
    <li class="history-item ${chat.id===activeSessionId?"active":""}" data-id="${chat.id}">
      <div class="history-row">
        <div class="history-item-title">${escapeHtml(chat.title || "New Chat")}</div>
        <button class="history-del" data-del="${chat.id}" title="Delete chat"><i class="fas fa-trash"></i></button>
      </div>
      <div class="history-preview">${escapeHtml(chat.preview || "No messages yet")}</div>
      <div class="history-time">${escapeHtml(formatTime(chat.updated_at))}</div>
    </li>
  `).join("");
}

async function loadSession(sessionId){
  try{
    const r=await fetch("/api/chat/history",{
      method:"POST",
      headers:authHeaders(),
      body:JSON.stringify({session_id:sessionId})
    });
    const d=await r.json();
    const history=d.history || [];
    messages.innerHTML='';
    if(!history.length){
      renderWelcome();
    }else{
      history.forEach(msg=>addMsg(msg.content,msg.role,{animate:false}));
    }
    setActiveSession(sessionId);
    renderHistoryList(chatCache);
    closeHistory();
  }catch{
    addMsg("Failed to load chat history.","bot");
  }
}

async function deleteSession(sessionId){
  await fetch("/api/chat/delete",{
    method:"POST",
    headers:authHeaders(),
    body:JSON.stringify({session_id:sessionId})
  });
  if(sessionBackgroundMap[sessionId]){
    delete sessionBackgroundMap[sessionId];
    localStorage.setItem("sessionBackgroundMap",JSON.stringify(sessionBackgroundMap));
  }
  if(activeSessionId===sessionId){
    startNewChat();
  }
  await loadHistoryList();
}

function startNewChat(){
  setActiveSession(createSessionId());
  renderWelcome();
}

function autoResizeInput(){
  input.style.height="auto";
  input.style.height=Math.min(input.scrollHeight,140)+"px";
}

async function sendMessage(forcedText="",options={}){
  const {asRegenerate=false}=options;
  const text=(forcedText || input.value).trim();
  if(!text) return;
  if(!activeSessionId){
    setActiveSession(createSessionId());
  }
  if(!asRegenerate){
    addMsg(text,"user");
    input.value="";
    autoResizeInput();
  }
  const typingMsg=addMsg("...","bot");

  try{
    const r=await fetch("/api/chat",{
      method:"POST",
      headers:authHeaders(),
      body:JSON.stringify({prompt:text,history:[],session_id:activeSessionId})
    });
    const d=await r.json();
    typingMsg.remove();
    addMsg(d.response||"Error","bot");
    await loadHistoryList();
  }catch{
    typingMsg.remove();
    addMsg("Network error.","bot");
  }
}

sendBtn.onclick=()=>sendMessage();
micBtn.onclick=toggleVoiceInput;
input.addEventListener("input",autoResizeInput);
input.addEventListener("keydown",e=>{
  if(e.key==="Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

codeModalCloseBtn.onclick=closeCodeModal;
codeModal.onclick=(e)=>{
  if(e.target===codeModal) closeCodeModal();
};
codeModalCopyBtn.onclick=()=>{
  if(!codeModalCurrentCode) return;
  navigator.clipboard.writeText(codeModalCurrentCode);
  showToast("Code copied.");
};
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape" && codeModal.classList.contains("open")){
    closeCodeModal();
  }
});

historyBtn.onclick=async ()=>{
  openHistory();
  await loadHistoryList();
};
closeHistoryBtn.onclick=closeHistory;
historyOverlay.onclick=closeHistory;
newChatBtn.onclick=()=>{
  startNewChat();
  closeHistory();
};
clearChatsBtn.onclick=async ()=>{
  await fetch("/api/chats/clear",{
    method:"POST",
    headers:authHeaders()
  });
  sessionBackgroundMap={};
  localStorage.setItem("sessionBackgroundMap","{}");
  startNewChat();
  await loadHistoryList();
};

historyList.addEventListener("click",async (e)=>{
  const delBtn=e.target.closest("[data-del]");
  if(delBtn){
    await deleteSession(delBtn.dataset.del);
    return;
  }
  const item=e.target.closest("[data-id]");
  if(item){
    await loadSession(item.dataset.id);
  }
});

(async ()=>{
  if(!activeSessionId){
    startNewChat();
  }else{
    applySessionBackground(activeSessionId);
    await loadSession(activeSessionId);
  }
  await loadHistoryList();
})();
</script>

</body>
</html>
